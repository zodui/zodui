<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="alternate icon" class="js-site-favicon" type="image/png" href="/zodui.png">
  <link rel="icon" class="js-site-favicon" type="image/svg+xml" href="/zodui.svg">
  <title>Zod UI</title>
  <style lang="css" data-name="message">
    div.message {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translate(-50%, -150%);
      padding: 1em;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: 0.3s ease-in-out;
    }
    div.message.show {
      opacity: 1;
      transform: translateX(-50%);
    }
  </style>
  <style type="text/css">
    body {
      display: flex;
      margin: 0;
      padding-top: 50px;
    }
    #container {
      width: 500px;
    }
    #root {
      width: calc(100% - 500px);
      height: calc(100vh - 50px);
      overflow: overlay;
    }
  </style>
  <style lang="css" data-name="header">
    body > .header {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      width: calc(100vw - 40px);
      height: 50px;
      background-color: #3E67B1;
      box-shadow: 0 0 10px gray;
    }
    body > .header > .header-left > a {
      display: flex;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      text-decoration: none;
      color: #18263F;;
      transition: .1s;
    }
    body > .header > .header-left > a:active,
    body > .header > .header-left > a:hover {
      text-shadow: 0 0 16px lightgray;
    }
  </style>

  <script>
    var require = { paths: { vs: './monaco/min/vs' } }
  </script>
  <link
    rel="stylesheet"
    data-name="vs/editor/editor.main"
    href="/monaco/min/vs/editor/editor.main.css"
  >
  <script src="/monaco/min/vs/loader.js"></script>
  <script src="/monaco/min/vs/editor/editor.main.nls.js"></script>
  <script src="/monaco/min/vs/editor/editor.main.js"></script>

  <template id="message-template">
    <div class="message">
      {{content}}
    </div>
  </template>
  <script data-name="lib">
    ;(function () {
      const tmplCache = {}
      /**
       * create a template from a template node
       *
       * @param {string} tmplId
       * @param {Record<string, any>} data
       * @returns {Element}
       */
      window.createEleByTmpl = function (tmplId, data) {
        const tmpl = tmplCache[tmplId] || (tmplCache[tmplId] = document.getElementById(tmplId).innerHTML.trim())

        const div = document.createElement('div')
        div.innerHTML = Object.keys(data).reduce((acc, key) => {
          return acc.replace(new RegExp(`{{${key}}}`, 'g'), data[key])
        }, tmpl)
        return div.children[0]
      }
      /**
       * copy content to clipboard
       * @param {string} content
       */
      window.copyToClipboard = function (content) {
        const input = document.createElement('input')
        input.value = content
        document.body.appendChild(input)
        input.select()
        document.execCommand('copy')
        document.body.removeChild(input)
      }
      /**
       * base64 encode and decode
       * @param {string} str
       * @param {boolean} isDecode
       */
      window.base64 = function (str, isDecode = true) {
        return isDecode ? decodeURIComponent(atob(str)) : btoa(encodeURIComponent(str))
      }
      /**
       * throttle
       * @param {Function} fn
       * @param {number} delay
       */
      window.throttle = function (fn, delay) {
        let timer = null
        return function (...args) {
          if (timer) return
          timer = setTimeout(() => {
            fn.apply(this, args)
            timer = null
          }, delay)
        }
      }
      /**
       * debounce
       * @param {Function} fn
       * @param {number} delay
       */
      window.debounce = function (fn, delay) {
        let timer = null
        return function (...args) {
          if (timer) clearTimeout(timer)
          timer = setTimeout(() => {
            fn.apply(this, args)
            timer = null
          }, delay)
        }
      }
      let messages = []
      /**
       * display a message
       * @param {string} content
       * @param {number} duration
       */
      window.showMessage = function (content, duration = 3000) {
        const message = createEleByTmpl('message-template', { content })
        // compute message top
        const top = messages.reduce((acc, msg) => {
          return acc + msg.offsetHeight + 10
        }, 10)
        message.style.top = top + 'px'
        document.body.appendChild(message)
        messages.push(message)
        setTimeout(() => {
          message.classList.add('show')
        }, 0)
        setTimeout(() => {
          message.classList.remove('show')
          setTimeout(() => {
            document.body.removeChild(message)
            messages = messages.filter((m) => m !== message)
          }, 300)
        }, duration)
      }
    })()
  </script>

  <script data-name="monaco">
    /**
     * @type {monaco.editor.IStandaloneCodeEditor}
     */
    let editor
    const changeListeners = []
    window.onCodeChange = function (fn) {
      // TODO refactor as import maps
      const nfn = s => fn(`${s}
;(window?.____DEFAULT_EXPORT_VALUE____)`
        .replace('export default ', 'window.____DEFAULT_EXPORT_VALUE____ = ')
        .replace(/import ([\s\S]*) from 'zod'/g, 'var $1 = window.z')
        .replace(/\* as/g, '')
        .replace(/import ([\s\S]*) from .*/g, ''))
      changeListeners.push(nfn)
      nfn(editor?.getValue())
      const index = changeListeners.length - 1
      return () => {
        if (index > -1) changeListeners.splice(index, 1)
      }
    }
    /**
     * @param {string} s
     */
    function updateCode(s) {
      changeListeners.forEach((fn) => fn(s))
    }
    window.addEventListener('load', function () {
      function setCodeByUrl() {
        const hash = location.hash.slice(1)
        const code = hash ? base64(hash) : `
import * as z from 'zod'

export default z.object({
  foo: z.string()
})
`.trim()
        editor.setValue(code)
        updateCode(code)
      }

      // watch hash change
      window.addEventListener('hashchange', setCodeByUrl)
      // add custom dts
      /** @type {{
       content: string;
       filePath: string;
      }[]} */
      const zodDtsFile = <%- ZOD_DTS_FILES %>;
      monaco.languages.typescript.typescriptDefaults.setExtraLibs(zodDtsFile)
      monaco.languages.typescript.typescriptDefaults.addExtraLib(`import z, { Schema, ZodDefaultDef, ZodFirstPartyTypeKind, ZodObject, ZodType, ZodTypeAny } from 'zod'

export interface ModesMap {
  [ZodFirstPartyTypeKind.ZodNumber]:
    | 'slider'
    | 'rate'
  [ZodFirstPartyTypeKind.ZodString]:
    | 'textarea'
    | 'link'
    | 'secrets'
    | 'date'
    | 'datetime'
    | 'time'
    | 'panel'
  [ZodFirstPartyTypeKind.ZodBoolean]:
    | 'checkbox'
  [ZodFirstPartyTypeKind.ZodDate]:
    | 'datetime'
    | 'time'
    | 'panel'
  [ZodFirstPartyTypeKind.ZodTuple]:
    | 'range'
    | 'slider'
    | 'no-range'
    | 'no-slider'
    | 'datetime'
    | 'time'
    | 'panel'
}

declare module 'zod' {
  export interface ZodTypeDef {
    mode: string
    label: string
  }
  export interface ZodType<Output = any, Def extends ZodTypeDef = ZodTypeDef, Input = Output> {
    readonly _mode: string
    mode<T extends string>(
      mode:
        | Def extends ZodDefaultDef<infer InnerT>
          ? ModesMap[InnerT['_def']['typeName']]
          : ModesMap[Def['typeName']]
        | (string & {})
    ): ZodType<Output, Def, Input>

    readonly _label: string
    label(mode: string): ZodType<Output, Def, Input>

    readonly type: string
  }
  export function clazz<T>(clazz: { new(): T }): Schema<T>
  export function asObejct<T extends any>(t: T): ZodObject<Record<string, ZodTypeAny> & T>
}`, 'file:///env.d.ts')
      editor = monaco.editor.create(document.getElementById('container'), {
        // theme: 'vs-dark',
        value: '',
        language: 'typescript',
        tabIndex: 2,
        model: monaco.editor.createModel('', 'typescript', monaco.Uri.parse('file:///main.ts')),
      })

      setCodeByUrl()
      const historyCodes = []
      let historyIndex = -1
      // watch editor value change
      editor.onDidChangeModelContent(debounce(function () {
        updateCode(editor.getValue())
      }, 1500))
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => {
        const code = editor.getValue()
        updateCode(code)
        // save code to hash
        location.hash = `#${base64(code, false)}`
        // copy url to clipboard
        copyToClipboard(location.href)
        showMessage('<h3 style="margin: 0">url copied to clipboard, share it with your friends!</h3>')
      })
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.UpArrow, function () {
        if (historyIndex === -1) {
          historyIndex = historyCodes.length - 1
        } else {
          historyIndex--
        }
        if (historyIndex < 0) {
          historyIndex = 0
        }
        editor.setValue(historyCodes[historyIndex].code)
      })
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.DownArrow, function () {
        if (historyIndex === -1) {
          historyIndex = historyCodes.length - 1
        } else {
          historyIndex++
        }
        if (historyIndex >= historyCodes.length) {
          historyIndex = historyCodes.length - 1
        }
        editor.setValue(historyCodes[historyIndex].code)
      })
      editor.focus()
    })
  </script>
</head>
<body>
<div class='header'>
  <div class='header-left'>
    <a href='/'>
      <img src='/zodui.svg'
           alt='ZodUI'
           width='48'
           height='48'
      >
      &nbsp;
      Zod&nbsp;<span style='color: white'>UI</span>
    </a>
  </div>
  <div class='header-right'>
    <a href='https://github.com/zodui/zodui' target='_blank'>
      <img src='https://github.githubassets.com/favicons/favicon.svg'
           alt='GitHub ZodUI Repsitory'
           width='32'
           height='32'
      >
    </a>
  </div>
</div>
<div id='container'></div>
<div id="root"></div>
<script type="module" src="/src/main.tsx"></script>
</body>
</html>
